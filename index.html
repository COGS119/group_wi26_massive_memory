<!DOCTYPE html>
<html>

<head>
  <title>Massive Memory</title>
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.2.1"></script>
  <!-- This is for data storage - please be sure to keep this script in all future updates to the code!! -->
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
  <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
</head>

<body></body>
<script>

  /* initialize jsPsych */
  var jsPsych = initJsPsych({
    on_finish: function () {
      jsPsych.data.displayData();
    }
  });

  /* create timeline */
  var timeline = [];

  //PLEASE KEEP FOR ALL FUTURE ITERATIONS
  //create a unique filename by combining a random string and a millisecond counter (to avoid duplicates)
  var random_id = jsPsych.randomization.randomID(10);
  const date = new Date();
  random_id = "p" + random_id.toString();
  var file_id = random_id + "_" + date.getTime().toString();
  const filename = `${file_id}.csv`;
  //also store the random id for convenience
  jsPsych.data.addProperties({
    random_id: random_id,
  });
  //PLEASE KEEP FOR ALL FUTURE ITERATIONS



  /* fullscreen mode */
  var enter_fullscreen = {
    type: jsPsychFullscreen,
    fullscreen_mode: true
  }
  timeline.push(enter_fullscreen);

/*  var trial_in_fullscreen = {
    type: jsPsychHtmlButtonResponse,
    stimulus: 'This trial will be in fullscreen mode. Do not use Safari to run.',
    choices: ['Continue']
  }
  timeline.push(trial_in_fullscreen);
 */ 
  // create a short survey to collect a participant identifier
  var participant_id_entry = {
    type: jsPsychSurveyText,
    questions: [{ prompt: "Please enter your participant ID (e.g. p1):", name: "participant_id" }],
    on_finish: function (data) {
      console.log(data.response)
      jsPsych.data.addProperties({
        participant: data.response.participant_id
      });
    }
  };
  timeline.push(participant_id_entry);

  /* Welcome message trial */
  var instructions = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <p>In this experiment, a series of objects will be displayed.</p>
      <p>Try to memorize as much as possible about the objects.</p>
      <p>If the image is a <strong> repeat</strong>, press the SPACEBAR.</p>
      <p>Press any key to begin.</p>
    `
  };
  timeline.push(instructions);


  /* item name arrays */

  // Exemplar item names — all use .jpg except "teapot" which uses .JPG
  var exemplar_names = [
    "basket", "bell", "bicycle", "bracelet", "bread", "cabinet", "calculator",
    "camera", "car", "chisel", "chocolatebar", "cone", "dispenser", "fan",
    "feather", "frame", "game", "globe", "goggles", "grapes", "hanger",
    "headphones", "helmet", "holepunch", "horn", "icecream", "key", "ladder",
    "meter", "microscope", "mitt", "money", "muffin", "muffler", "nozzle",
    "pacifier", "peppers", "piano", "pizza", "pliers", "potatochips", "razor",
    "remote", "sharpener", "soapdish", "soccerball", "spraybottle", "stapler",
    "starfish", "string", "suitcase", "sunglasses", "teapot", "tongs", "toyplane",
    "tractor", "train", "trophy", "turtle", "wheelchair"
  ];

  // State items where BOTH files use .jpg
  var state_jpg = [
    "abacus", "applesgreenbasket", "belt", "box", "briefcase", "brushes",
    "chinesefoodbox", "crayons", "die", "donut", "dresser", "drum", "dryer",
    "eggs", "firetrucktoy", "flask", "giftbag", "giftbox", "grinder",
    "hairbrush", "iron", "medicaltape", "mug", "napkins", "patiotable",
    "peppers", "pestle", "picnicbasket", "polarbear", "pumpkinpie",
    "racquet", "rhino", "scales", "seatbelt", "seats", "sweater",
    "teacup", "tent", "tiger", "typewriter", "waffleiron", "yarn"
  ];

  // State items where BOTH files use .JPG
  var state_JPG = [
    "babytoy", "books", "bottles", "breadbox", "bureau", "coffeemaker",
    "container", "cookies", "dishes", "juiceglass", "laptop", "phone",
    "pie", "potpan", "scanner", "scissors"
  ];

  /* build test_list from name arrays */
  var test_list = [];

  // Add exemplar pairs
  exemplar_names.forEach(function (name) {
    var ext = (name === "teapot") ? ".JPG" : ".jpg";
    test_list.push({
      item_1: "E" + name + "1" + ext,
      item_2: "E" + name + "2" + ext,
      test_type: "exemplar",
      path_to_image: "stimuli/organized/EXEMPLAR/USED/"
    });
  });

  // Add state pairs (.jpg extension)
  state_jpg.forEach(function (name) {
    test_list.push({
      item_1: "S" + name + "1.jpg",
      item_2: "S" + name + "2.jpg",
      test_type: "state",
      path_to_image: "stimuli/organized/STATE/USED/"
    });
  });

  // Add state pairs (.JPG extension)
  state_JPG.forEach(function (name) {
    test_list.push({
      item_1: "S" + name + "1.JPG",
      item_2: "S" + name + "2.JPG",
      test_type: "state",
      path_to_image: "stimuli/organized/STATE/USED/"
    });
  });

  // Add the 2 state pairs with mismatched extensions
  test_list.push({
    item_1: "Sbagel1.JPG", item_2: "Sbagel2.jpg",
    test_type: "state", path_to_image: "stimuli/organized/STATE/USED/"
  });
  test_list.push({
    item_1: "Smetronome1.jpg", item_2: "Smetronome2.JPG",
    test_type: "state", path_to_image: "stimuli/organized/STATE/USED/"
  });

  // Counterbalance: randomly swap item_1/item_2 for exactly half of all pairs
  // repeat([true, false], N) creates N trues + N falses, shuffled
  var swap_flags = jsPsych.randomization.repeat([true, false], Math.floor(test_list.length / 2));

  test_list.forEach(function (pair, index) {
    if (swap_flags[index]) {
      var temp = pair.item_1;
      pair.item_1 = pair.item_2;
      pair.item_2 = temp;
    }
  });

  /* build memory list from test list (study the item_1 from each pair) */
  var memory_list = test_list.map(function (item) {
    return item.path_to_image + item.item_1;
  });

  // Shuffle the memory list
  var memory_list_shuffled = jsPsych.randomization.shuffle(memory_list);

  // Attention check: pick 2 random images to repeat later in the study phase
  // Build study_list with is_repeat flags
  var study_list = memory_list_shuffled.map(function (path) {
    return { path: path, is_repeat: false };
  });

  // Pick 2 random indices to repeat, insert copies at least 5 trials later
  var repeat_indices = jsPsych.randomization.sampleWithoutReplacement(
    Array.from({ length: memory_list_shuffled.length }, function (_, i) { return i; }), 2
  );

  // Sort descending so splice positions don't shift when inserting
  repeat_indices.sort(function (a, b) { return b - a; });

  repeat_indices.forEach(function (orig_idx) {
    // insert the repeat at a random position at least 5 trials after the original
    var min_pos = orig_idx + 5;
    var max_pos = study_list.length;
    if (min_pos > max_pos) min_pos = max_pos; // edge case: near end of list
    var insert_pos = min_pos + Math.floor(Math.random() * (max_pos - min_pos + 1));
    study_list.splice(insert_pos, 0, { path: memory_list_shuffled[orig_idx], is_repeat: true });
  });

  // Cycle through study_list for the learning phase
  for (var i = 0; i < study_list.length; i++) {

    var current_image = study_list[i].path;
    var is_repeat = study_list[i].is_repeat;

    // Fixation cross — first one is always black, subsequent ones show
    // green (correct) or red (incorrect) based on previous trial response
    var fixation = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function () {
        // check if there was a previous memory trial
        var prev_trials = jsPsych.data.get().filter({ trial_phase: "memory" });
        if (prev_trials.count() === 0) {
          return '<div style="font-size:60px;">+</div>';
        }
        var last = prev_trials.last(1).values()[0];
        var pressed_space = last.response !== null;
        var was_repeat = last.is_repeat;
        // correct if: pressed on repeat OR didn't press on non-repeat
        var correct = (pressed_space && was_repeat) || (!pressed_space && !was_repeat);
        var color = correct ? "green" : "red";
        return '<div style="font-size:60px; color:' + color + ';">+</div>';
      },
      choices: "NO_KEYS",
      trial_duration: 1000,
    };
    timeline.push(fixation);

    // Image trial
    var trial = {
      type: jsPsychImageKeyboardResponse,
      stimulus: current_image,
      choices: [" "],
      trial_duration: 3000,
      response_ends_trial: false,
      prompt: '<p>Press <strong>SPACEBAR</strong> if you have seen this image before</p>',
      data: {
        trial_phase: "memory",
        is_repeat: is_repeat
      }
    }
    timeline.push(trial);
  }

  // Shuffle test list for test phase
  var test_list_shuffled = jsPsych.randomization.shuffle(test_list);

  // Cycle through test list using a for loop
  for (var i = 0; i < test_list_shuffled.length; i++) {
    var current_item = test_list_shuffled[i];
    var image_1 = current_item["path_to_image"] + current_item["item_1"];
    var image_2 = current_item["path_to_image"] + current_item["item_2"];

    var test_trial = {
      type: jsPsychHtmlButtonResponse,
      stimulus: "Which of these items did you see before?",
      choices: ['<img src="' + image_1 + '">', '<img src="' + image_2 + '">'],
      data: {
        trial_phase: "test",
        test_type: current_item.test_type
      }
    };
    timeline.push(test_trial);
  }

  // a short survey to collect what ppt thought this experiment was about
  var participant_task_guess_entry = {
    type: jsPsychSurveyText,
    questions: [{ prompt: "Please enter what you believe the experiment was about in 1 sentence.", name: "task_guess" }],
    on_finish: function (data) {
      console.log(data.response)
      jsPsych.data.addProperties({
        participant: data.response.task_guess
      });
    }
  };
  timeline.push(participant_task_guess_entry);

  var experiment_explanation = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <p>Thank you for participating!</p>
      <p>This experiment is about how people remember objects in different conditions.</p>
      <p>In the first phase, you studied a series of images. Some of those images were repeated to check if you were paying attention.</p>
      <p>In the second phase, you were tested on your memory for those images by choosing which of two similar images you'd seen before.</p>
      <p>We are interested in whether people can remember the nuances/specific details of objects in their long-term memory.</p>
    `,
    choices: ['Finish']
  }
  timeline.push(experiment_explanation);

  // a short survey to collect if ppt had technical issues
  var technical_issues_question = {
    type: jsPsychSurveyText,
    questions: [{ prompt: "Did you have any technical issues?", name: "technical_issues_question" }],
    on_finish: function (data) {
      console.log(data.response)
      jsPsych.data.addProperties({
        participant: data.response.technical_issues_question
      });
    }
  };
  timeline.push(technical_issues_question);

  //PLEASE KEEP FOR ALL FUTURE ITERATIONS
  //this portion of the code ensures that the data gets sent to be stored on OSF
  const save_data = {
    type: jsPsychPipe,
    action: "save",
    experiment_id: "B0aqgL67QbG6",
    filename: filename,
    data_string: () => jsPsych.data.get().csv()
  };
  timeline.push(save_data);
  //PLEASE KEEP FOR ALL FUTURE ITERATIONS

  /* start the experiment */
  jsPsych.run(timeline);

</script>

</html>